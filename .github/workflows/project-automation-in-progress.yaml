name: Project Automation -- In Progress

on:
  issues:
    types: [assigned]

permissions:
  issues: write
  pull-requests: write
  projects: write
  contents: read

jobs:
  issue-assigned-move-to-in-progress:
    runs-on: ubuntu-latest
    steps:
      - name: Move issue to In Progress when assigned
        uses: actions/github-script@v7
        with:
          script: |
            const projectId = "PVT_kwDOAAnpb84BHVLK";
            const statusFieldId = "PVTSSF_lADOAAnpb84BHVLKzg4HfRU";
            const inProgressOptionId = "47fc9ee4";

            const issue = context.payload.issue;

            // Fetch all project items and find the one for this issue
            const result = await github.graphql(`
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 200) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            id
                            number
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, { projectId });

            const item = result.node.items.nodes.find(i =>
              i.content?.id === issue.node_id
            );

            if (!item) {
              console.log("Issue not in this project, skipping.");
              return;
            }

            const itemId = item.id;

            // Update Status field â†’ In Progress
            await github.graphql(`
              mutation($itemId: ID!, $statusFieldId: ID!, $inProgressOptionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  itemId: $itemId,
                  fieldId: $statusFieldId,
                  projectId: "${projectId}",
                  value: { singleSelectOptionId: $inProgressOptionId }
                }) {
                  clientMutationId
                }
              }
            `, {
              itemId,
              statusFieldId,
              inProgressOptionId
            });

            console.log(`Moved Issue #${issue.number} to In Progress`);
