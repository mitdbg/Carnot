name: Project Automation -- In Review

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  pr-linked-set-in-review:
    if: |
      github.event.pull_request.base.ref == 'dev' ||
      github.event.pull_request.base.ref == 'main'

    permissions:
      contents: read
      issues: write
      pull-requests: write

    runs-on: ubuntu-latest
    steps:
      - name: Move linked issues to In Review when PR targets dev or main
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CARNOT_PROJECT_TOKEN }}
          script: |
            const projectId = "PVT_kwDOAAnpb84BHVLK";
            const statusFieldId = "PVTSSF_lADOAAnpb84BHVLKzg4HfRU";
            const inReviewOptionId = "PVTFO_rev789";

            const pr = context.payload.pull_request;
            const body = pr.body || "";

            // Find `#123` references
            const matches = [...body.matchAll(/#(\d+)/g)];
            if (!matches.length) { return; }

            for (const match of matches) {
              const issueNumber = match[1];

              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });

              // Get project item
              const items = await github.graphql(`
                query($projectId: ID!, $issueId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 50, filterBy: {contentId: $issueId}) {
                        nodes { id }
                      }
                    }
                  }
                }
              `, {
                projectId,
                issueId: issue.data.node_id
              });

              const itemId = items.node.items.nodes[0]?.id;
              if (!itemId) { continue; }

              // Update status to In Review
              await github.graphql(`
                mutation($itemId: ID!, $statusFieldId: ID!, $inReviewOptionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    itemId: $itemId,
                    fieldId: $statusFieldId,
                    projectId: "${projectId}",
                    value: { singleSelectOptionId: $inReviewOptionId }
                  }) { clientMutationId }
                }
              `, {
                itemId,
                statusFieldId,
                inReviewOptionId
              });
            }
