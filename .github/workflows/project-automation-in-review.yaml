name: Project Automation -- In Review

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  pr-linked-set-in-review:
    if: |
      github.event.pull_request.base.ref == 'dev' ||
      github.event.pull_request.base.ref == 'main'

    permissions:
      contents: read
      issues: write
      pull-requests: write

    runs-on: ubuntu-latest

    steps:
      - name: Move linked issues to In Review when PR targets dev or main
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CARNOT_PROJECT_TOKEN }}
          script: |
            const projectId = "PVT_kwDOAAnpb84BHVLK";
            const statusFieldId = "PVTSSF_lADOAAnpb84BHVLKzg4HfRU";
            const inReviewOptionId = "PVTFO_rev789";

            const pr = context.payload.pull_request;
            const body = pr.body || "";

            // Find #123 style issue references
            const matches = [...body.matchAll(/#(\d+)/g)];
            if (!matches.length) {
              console.log("No linked issues found in PR body.");
              return;
            }

            for (const match of matches) {
              const issueNumber = match[1];

              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });

              const issueNodeId = issue.data.node_id;

              const result = await github.graphql(`
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100) {
                        nodes {
                          id
                          content {
                            ... on Issue { id }
                            ... on PullRequest { id }
                          }
                        }
                      }
                    }
                  }
                }
              `, { projectId });

              const items = result.node.items.nodes;
              const item = items.find(i => i.content?.id === issueNodeId);

              if (!item) {
                console.log("Issue #" + issueNumber + " is not in the project, skipping.");
                continue;
              }

              console.log("Updating project item " + item.id +
                " for issue #" + issueNumber + " to In Review");

              await github.graphql(`
                mutation($itemId: ID!, $statusFieldId: ID!, $inReviewOptionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: "${projectId}",
                    itemId: $itemId,
                    fieldId: $statusFieldId,
                    value: { singleSelectOptionId: $inReviewOptionId }
                  }) {
                    clientMutationId
                  }
                }
              `, {
                itemId: item.id,
                statusFieldId,
                inReviewOptionId
              });
            }

            console.log("âœ… All linked issues moved to In Review");
